# 雪晶分類器 (Snow Crystal Classifier)

雪の結晶画像から「霰（あられ）」と「雪片」を自動で見分ける機械学習プログラムです。

## このプロジェクトについて

### 何をするプログラムか

雪の結晶には様々な形があります。このプログラムは、雪の結晶の画像を見て、それが「霰 (graupel)」なのか「雪片 (snowflake)」なのかを判定します。

- *graupel*（霰）: 丸っこい粒状の雪。雲の中で雪の結晶に水滴がくっついてできる
- *snowflake*（雪片）: 六角形の美しい形をした雪の結晶

### どうやって見分けるのか

人間が雪の結晶を見分けるとき、「形が丸いか」「複雑な模様があるか」などの特徴を見ています。このプログラムも同じように、画像から特徴を数値として取り出し、その数値をもとに判定します。

具体的には、以下の4種類の特徴を画像から抽出しています。

| 特徴の種類 | 何を見ているか | 例 |
|-----------|--------------|-----|
| 形状特徴 | 輪郭の形、丸さ、複雑さ | 霰は丸い、雪片は複雑 |
| テクスチャ特徴 | 表面の模様、パターン | 雪片は細かい模様がある |
| エッジ特徴 | 輪郭の鮮明さ、方向 | 雪片はエッジが多い |
| 統計特徴 | 明るさの分布 | 全体的な明暗の傾向 |

### 機械学習の仕組み

このプログラムでは *RandomForest*（ランダムフォレスト）という手法を使っています。

RandomForestは「たくさんの決定木を作って、多数決で答えを決める」方法です。

決定木とは、「もし〇〇なら→次の質問へ」という分岐を繰り返して答えにたどり着く仕組みです。例えば以下のような判断をします。

```
丸さが0.7以上？
├── はい → 霰
└── いいえ → エッジの数が多い？
              ├── はい → 雪片
              └── いいえ → 霰
```

1本の決定木だと間違えやすいですが、100本の決定木を作って多数決を取ることで、より正確な判定ができます。これがRandomForestの考え方です。

### 評価方法

プログラムの精度を測るために *クロスバリデーション*（交差検証）という方法を使っています。

データを5つのグループに分け、「4グループで学習→1グループでテスト」を5回繰り返します。こうすることで、すべてのデータがテストに使われ、偏りのない評価ができます。

```
1回目: [テスト][学習][学習][学習][学習]
2回目: [学習][テスト][学習][学習][学習]
3回目: [学習][学習][テスト][学習][学習]
4回目: [学習][学習][学習][テスト][学習]
5回目: [学習][学習][学習][学習][テスト]
```

### 評価指標の読み方

結果に表示される指標の意味は以下の通りです。

| 指標 | 意味 | この値が高いと |
|-----|------|--------------|
| *Accuracy* | 全体の正解率 | 全体的に正しく判定できている |
| *Precision* | 「霰」と判定したもののうち、本当に霰だった割合 | 誤検出が少ない |
| *Recall* | 本当に霰のもののうち、正しく「霰」と判定できた割合 | 見逃しが少ない |
| *F1* | PrecisionとRecallのバランスを取った指標 | 総合的に良い性能 |

## 使い方

### 必要な環境

- Python 3.12以上
- uv（パッケージマネージャ）

### インストール

```bash
git clone https://github.com/matsuda-tkm/snow-crystal-classifier.git
cd snow-crystal-classifier
uv sync
```

### 分類器の実行

```bash
uv run main.py
```

実行すると、5分割クロスバリデーションで評価を行い、結果を `output/` フォルダに保存します。

オプション:

| オプション | 説明 | デフォルト値 |
|-----------|------|-------------|
| --data-dir | データセットのパス | dataset |
| --output-dir | 出力先のパス | output |
| --n-folds | クロスバリデーションの分割数 | 5 |
| --image-size | 画像のリサイズサイズ | 128 |
| --seed | 乱数シード | 42 |

### 決定木の可視化

決定木がどのような判断をしているか可視化できます。

```bash
uv run visualize_tree.py
```

## データセット

`dataset/` フォルダに以下の構成で画像を配置してください。

```
dataset/
├── graupel/      # 霰の画像 (107枚)
│   ├── image1.png
│   └── ...
└── snowflake/    # 雪片の画像 (323枚)
    ├── image1.png
    └── ...
```

## 出力ファイル

実行後、`output/` フォルダに以下のファイルが生成されます。

| ファイル | 内容 |
|---------|------|
| confusion_matrix.png | 混同行列（予測と正解の対応表） |
| metrics.png | 評価指標のグラフ |
| results.csv | 評価指標の数値データ |

### 現在の性能

5分割クロスバリデーションでの評価結果:

| 指標 | 値 |
|-----|-----|
| Accuracy | 88.8% |
| Precision | 85.5% |
| Recall | 84.5% |
| F1 | 84.9% |

## ファイル構成

```
snow-crystal-classifier/
├── main.py              # メインスクリプト（クロスバリデーション評価）
├── classifier.py        # 分類器の実装
├── visualize_tree.py    # 決定木の可視化
├── pyproject.toml       # 依存関係の定義
├── dataset/             # データセット
└── output/              # 出力結果
```

## 技術詳細

### 抽出する特徴量（全65次元）

| カテゴリ | 特徴量 | 次元数 |
|---------|-------|--------|
| 形状 | 円形度、面積比、アスペクト比、Huモーメントなど | 10 |
| テクスチャ | LBPヒストグラム、Gaborフィルタ応答 | 32 |
| エッジ | エッジ密度、勾配統計、方向ヒストグラム | 12 |
| 統計 | 輝度統計、エントロピー、パーセンタイル | 11 |

### 使用ライブラリ

- OpenCV: 画像処理と特徴量抽出
- scikit-learn: RandomForest分類器と評価
- NumPy: 数値計算
- Matplotlib / Seaborn: 可視化
